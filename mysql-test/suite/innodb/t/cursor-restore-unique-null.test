--source include/have_innodb.inc
--source include/have_debug.inc
--source include/have_debug_sync.inc
--source include/count_sessions.inc


CREATE TABLE t(a INT PRIMARY KEY, b INT, c INT, UNIQUE KEY `b_c` (`b`,`c`))
  ENGINE=InnoDB, STATS_PERSISTENT=0;
INSERT INTO t(a) VALUES (1);

--connect con1,localhost,root

--let $i = 2

while ($i) {
  --connection con1
  BEGIN;
  if ($i == 2) {
    INSERT INTO t SET a=2;
  }
  if ($i == 1) {
    INSERT INTO t SET a=2, c=2;
  }

  --connection default
  BEGIN;
  SET DEBUG_SYNC="lock_wait_suspend_thread_enter SIGNAL select_locked";
  --send SELECT * FROM t FORCE INDEX(b) FOR UPDATE

  --connection con1
  SET DEBUG_SYNC="now WAIT_FOR select_locked";
  ROLLBACK;

  --connection default
  if ($i == 2) {
    --echo # If the bug is not fixed, and the both unique index key fields are
    --echo # NULL, there will be two (1, NULL, NULL) rows in the result,
    --echo # because cursor will be restored to (NULL, NULL, 1) position for
    --echo # secondary key instead of "supremum".
  }
  --reap
  COMMIT;
  --dec $i
}

SET DEBUG_SYNC="RESET";


--disconnect con1
DROP TABLE t;
--source include/wait_until_count_sessions.inc
